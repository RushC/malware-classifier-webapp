/**
 * This script contains functions for downloading specific portions of the result page.
 */

/**
 * Downloads the object at the specified URL as a file with the specified file name.
 */
function download(url, fileName) {
    
    // An object can be downloaded by creating an anonymous <a> element and simulating\
    // a click on it.
    var a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    a.click();
}

/**
 * Downloads the assembly view as a .asm file.
 */
function downloadAsmFile() {
    var asmString = $('#asm-view')[0].innerHTML;
    downloadText(asmString, getFileName('.asm'));
}

/**
 * Downloads the hex view as a .bytes file.
 */
function downloadHexFile() {
    var hexString = $('#hex-view')[0].innerHTML;    
    downloadText(hexString, getFileName('.bytes'));
}

/**
 * Downloads the image displayed in the #image element.
 */
function downloadImage() {
    var imageString = $('#image')[0].src;
    download(imageString, getFileName('.png'));
}

/**
 * Downloads the specified string as a plain text file with the specified file name.
 */
function downloadText(text, fileName) {
    
    // If the user is running windows, replace the text's line endings with Windows compatible
    // line endings.
    var windows = window.navigator.platform.includes('Win');
    if (windows)
        text = text.replace(/\n/g, '\r\n');
    
    // Encode the text and insert it into a base64 string.
    var base64String = 'data:text/plain;charset=utf-8,';
    base64String += encodeURIComponent(text);
    
    // Download the text.
    download(base64String, fileName);
}

/**
 * Gets the name of the currently selected file with its file extension
 * replaced with the specified extension.
 */
function getFileName(extension) {
    // Prepend the period if necessary.
    if (!extension.includes('.'))
        extension = '.' + extension;
    
    // Replace the actual extension with the given extension.
    var fileName = this.file.name.replace(/\.\w+$/, extension);
    
    // In case the file didn't have an extension.
    if (!fileName.endsWith(extension))
        fileName += extension;
    
    return fileName;
}
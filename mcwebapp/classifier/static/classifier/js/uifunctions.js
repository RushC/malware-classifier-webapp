/**
 * This script contains functions for making changes to the UI elements in the
 * web page.
 */

// Set the default easing for animations to the FastInSlowOut easing function
// defined in Android for Material Design (I just think it looks nice...):
// 
// https://developer.android.com/reference/android/support/v4/view/animation/FastOutSlowInInterpolator.html
$.easing._default = $.bez([.04, 0, .2, 1]);

// The margin between cards (in pixels).
var cardMargin = 20;

// The number of pixels an element being animated in should slide vertically.
var SLIDE_DISTANCE = 100;

/**
 * Hides the update log.
 */
function hideLog() {
    
    // Animate the update log up through the top of the screen.
    var logRect = $('#update-log')[0].getBoundingClientRect();
    hideTop = -logRect.height - logRect.top;
    $('#update-log').animate({marginTop: hideTop}, function() { $(this).hide(); });
}

/**
 * Hides all of the tool buttons.
 */
function hideToolButtons() {
    
    // Animate the card out and then hide it.
    var $toolCard = $('#tool-buttons-card');
    $toolCard.animate({marginTop: SLIDE_DISTANCE, opacity: 0}, function() { $(this).hide(); });
}

/**
 * Hides the upload card from view.
 */
function hideUploadCard() {
   
    // Animate the upload card and tool button card up through the top of the screen.
    var cardRect = $('#upload-card')[0].getBoundingClientRect();
    var hideTop = -cardRect.height - cardRect.top;
    $('#upload-card').animate({marginTop: hideTop}, function() { $(this).hide(); });
    $('#tool-buttons-card').animate({marginTop: hideTop}, function() { $(this).hide(); });
}

/**
 * Displays the specified results on the results cards and makes the card visible.
 */
function showResults(results) {
    
    // Class Card
    $('#file-name').html(file.name);
    $('#class-name').html(results.ClassName);
    $('#class-description').html(results.ClassDescription);
    $('#class-link')[0].href = results.ClassLink;
    $('#confidence').html((results.Confidence * 100).toFixed(2) + '%');
    
    // Assembly View
    var visible = !!results.AsmView;
    $('#asm-view-card').css({display: visible ? 'visible' : 'none'});
    
    if (visible)
        $('#asm-view').html(results.AsmView)
    
    
    // Hex View
    var visible = !!results.HexView;
    $('#hex-view-card').css({display: results.HexView !== null ? 'visible' : 'none'});
    
    if (visible)
        $('#hex-view').html(results.HexView);
    
    // Image
    $('#image-card').css({display: 'visible'});
    $('#image').attr('src', 'data:image/png;base64,' + results.Image);
    
    // Animate the results row into view.
    $('#results-row').css({display: 'block', opacity: 0, marginTop: 500})
                     .animate({opacity: 1, marginTop: 0});
    
    console.log(results.SimilarSample);
}

/**
 * Shows all of the tool buttons.
 */
function showToolButtons() {
    
    // Stop any currently running animations.
    var $toolButtonsCard = $('#tool-buttons-card');
    $toolButtonsCard.stop();
    
    // Set the margin and opacity for the card tool card to be animated from.
    $toolButtonsCard.css({marginTop: SLIDE_DISTANCE, opacity: 0});
    
    // Animate the card in.
    $toolButtonsCard.show().animate({marginTop: 0, opacity: 1}, 250);
}

/**
 * Updates the title, text, and class of the #file-box. Only arguments that are
 * specified will be updated. Everything else will stay the same.
 */
function updateFileBox(title, text, cls) {
    
    // Change title/text.
    if (title) $('#file-box > .card-content > .card-title').html(title);
    if (text)  $('#file-box > .card-content > p').html(text);
    
    // Replace the last added class with the new class.
    if (cls) {
        lastClass = $('#file-box').attr('class').split(' ').pop();
        
        // Ensure we are not replacing the current class with itself.
        if (cls !== lastClass)
            $('#file-box').switchClass(lastClass, cls);
    }
}

/**
 * Adds the specified message to the update log.
 */
function updateLog(message) {
    
    // Add a hidden element containing the message to the update log.
    $('#update-log').append('<h5 style="margin-top: ' + SLIDE_DISTANCE + 'px; opacity: 0">' + message + '</h5>');
    
    // Animate the element to its non-hidden state.
    $('#update-log > h5').animate({marginTop: 0, opacity: 1});
}
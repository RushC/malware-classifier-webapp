from django.http import HttpResponse
from django.views.decorators.csrf import csrf_exempt
from .malware_classifier.malware_classifier.exe.storage import ExeRawSample

@csrf_exempt
def validate(request):
    """Validate that the sent file can be classified. If the file is valid, a
    response will be sent with the content "Valid". If the file is invalid, a
    response will be sent with the content "Invalid". If any error occurs,
    a proper status code will be set for the response.
    """
    
    # Working response to be returned.
    response = HttpResponse("Invalid")
    
    # If no file was passed, send a failed status code.
    if ('file' not in request.FILES):
        response.status_code = 400; # Bad Request
        response.reason_phrase = ("No file was passed. File is expected as a "
                                  "parameter named 'file' in a set of form "
                                  "data.")
        return response
    
    # Read in the file.
    contents = request.FILES['file'].read()
    
    # Check .exe format
    with ExeRawSample(data=contents) as exeSample:
        if (exeSample.validate()):
            response.content = "Valid"
            return response
    
    # No valid format was found.
    return response
    